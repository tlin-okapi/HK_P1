<div class="row" style="border-bottom: 1px solid #dddddd;">
	<!--div id="content" class="container col-md-9">
		<h1>{{ title }}</h1>
	</div-->
	<div id="left-content" class="container col-md-5" style="border-right: 1px solid #dddddd;">
	
		<h1>Money On the Table by Category</h1>
		<table>
			<col width="200px">
			<col width="100px">
			<col width="200px">
			<col width="100px">
			<tbody>
				<tr>
					<td style="border-left: 1px solid #dddddd; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; text-align: center">Money On the <br/>Table (US $)<sup>1</sup></td>
					<td style="border-right: 1px solid #dddddd; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; background-color:orange; text-align: center">&nbsp;<strong><span id="chart-tot-mot-category"></strong>&nbsp;</td>
					<td style="border-left: 1px solid #dddddd; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; text-align: center">Shipment <br/>Value (US $)<sup>1</sup></td>
					<td style="border-right: 1px solid #dddddd; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; background-color:orange; text-align: center">&nbsp;<strong><span id="chart-tot-value-category"></strong>&nbsp;</td>
				</tr>
				<tr>
					<td style="border-left: 1px solid #dddddd; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; text-align: center">Share of <br/>Total MOT<sup>1</sup></td>
					<td style="border-right: 1px solid #dddddd; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; background-color:orange; text-align: center">&nbsp;<strong><span id="chart-pct-mot-category"></strong>&nbsp;</td>
					<td style="border-left: 1px solid #dddddd; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; text-align: center">Share of Total <br/>Ship. Value<sup>1</sup></td>
					<td style="border-right: 1px solid #dddddd; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; background-color:orange; text-align: center">&nbsp;<strong><span id="chart-pct-value-category"></strong>&nbsp;</td>
				</tr>
			</tbody>
		</table>
		
		<br/>

		<div class="row"> <!--put header outside so that chart can line up with body-->
			<span id="chart-category-dummy" class="col-md-2"></span>
			<span class="col-md-10">
				<table id="table-category-dummy2" class="table table-condensed table-hover table-responsive table-striped">
					<col width="100px">
					<col width="80px">
					<col width="80px">
					<col width="80px">
					<col width="80px">
					<thead>
					<tr>
						<th><font size="2">&nbsp;&nbsp;&nbsp;Category&nbsp;&nbsp;&nbsp;</font></th>
						<th><font size="2">MOT <br/>(US $)</font></th>
						<th><font size="2">Share of Total <br/>MOT (%))</font></th>
						<th><font size="2">Ship. Value <br/>(US $))</font></th>
						<th><font size="2">Share of Total Ship. <br/>Value (%))</font></th>
					</tr>
					</thead>
				</table>
			</span>
		</div>
		
		<div class="row">
			<span id="chart-category" class="col-md-2"></span>
			<span class="col-md-10">
				<table id="table-category" class="table table-condensed table-hover table-responsive table-striped">
					<col width="100px" align="left">
					<col width="80px">
					<col width="80px">
					<col width="80px">
					<col width="80px">
				</table>
			</span>
		</div>
		
		<br/>
		<p style="border-top: 1px solid #dddddd;"></p>
		
		<h1>Contribution by Different Sourcing Office</h1>
		<div>
			<span id="chart-source" class="col-md-4"></span>
			<span class="col-md-8">
				<table id="table-source" class="table table-condensed table-hover table-responsive table-striped">
					<thead>
					<tr> <!--class="header">-->
						<th>Sourcing Office</th>
						<th>Ship. Value (US $)</th>
					</tr>
					</thead>
				</table>
			</span>
		</div>
	
	</div>	<!-- .left-content -->

	
	<div id="right-content" class="container col-md-5" style="border-right: 1px solid #dddddd;">
		<h1>Money On the Table - Top Vendors</h1>
		<table>
			<col width="200px">
			<col width="100px">
			<col width="200px">
			<col width="100px">
			<tbody>
				<tr>
					<td style="border-left: 1px solid #dddddd; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; text-align: center">Money On the <br/>Table (US $)<sup>2</sup></td>
					<td style="border-right: 1px solid #dddddd; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; background-color:orange; text-align: center">&nbsp;<strong><span id="chart-tot-mot-vendor"></strong>&nbsp;</td>
					<td style="border-left: 1px solid #dddddd; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; text-align: center">Shipment <br/>Value (US $)<sup>2</sup></td>
					<td style="border-right: 1px solid #dddddd; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; background-color:orange; text-align: center">&nbsp;<strong><span id="chart-tot-value-vendor"></strong>&nbsp;</td>
				</tr>
				<tr>
					<td style="border-left: 1px solid #dddddd; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; text-align: center">Share of <br/>Total MOT<sup>2</sup></td>
					<td style="border-right: 1px solid #dddddd; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; background-color:orange; text-align: center">&nbsp;<strong><span id="chart-pct-mot-vendor"></strong>&nbsp;</td>
					<td style="border-left: 1px solid #dddddd; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; text-align: center">Share of Total <br/>Ship. Value<sup>2</sup></td>
					<td style="border-right: 1px solid #dddddd; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; background-color:orange; text-align: center">&nbsp;<strong><span id="chart-pct-value-vendor"></strong>&nbsp;</td>
				</tr>
			</tbody>
		</table>
		
		<br/>

		<div class="row"> <!--put header outside so that chart can line up with body-->
			<span id="chart-vendor-dummy" class="col-md-2"></span>
			<span class="col-md-10">
				<table id="table-vendor-dummy" class="table table-condensed table-hover table-responsive table-striped">
					<col width="100px">
					<col width="80px">
					<col width="80px">
					<col width="80px">
					<col width="180px">
					<thead>
					<tr>
						<th><font size="2">&nbsp;&nbsp;&nbsp;Vendor&nbsp;&nbsp;&nbsp;</font></th>
						<th><font size="2">MOT <br/>(US $)</font></th>
						<th><font size="2">Share of Total <br/>MOT (%)</font></th>
						<th><font size="2">Ship. Value <br/>(US $)</font></th>
						<th><font size="2">Share of Total Ship. <br/>Value (%)</font></th>
					</tr>
					</thead>
				</table>
			</span>
		</div>

		<div class="row">
			<span id="chart-vendor" class="col-md-2"></span>
			<span class="col-md-10">
				<table id="table-vendor" class="table table-condensed table-hover table-responsive table-striped">
					<col width="100px">
					<col width="80px">
					<col width="80px">
					<col width="80px">
					<col width="180px">
				</table>
			</span>
		</div>
		
		<br/>
		<p style="border-top: 1px solid #dddddd;"></p>
			
		<h1>Key Commodities Movement</h1>
		<table id="chart-currency-commodity" class="table table-condensed table-hover table-responsive table-striped">
			<thead>
                <tr> 
                    <th>Currency</th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th>Commodities</th>
                    <th></th>
                    <th></th>
                    <th></th>
                </tr>
                <tr> 
                    <th></th>
                    <th><font size="2">2015.06</font></th>
                    <th><font size="2">2016.06</font></th>
                    <th>YoY%</th>
                    <th></th>
                    <th><font size="2">2015.06</font></th>
                    <th><font size="2">2016.06</font></th>
                    <th>YoY%</th>
                </tr>
			</thead>
			<tbody>
                <tr> 
                    <td nowrap>Currency 1</td>
                    <td>7.74</td>
                    <td>7.76</td>
                    <td><font color="green">+0.3%</font></td>
                    <td nowrap>Commodity 1</td>
                    <td>800.2</td>
                    <td>680.2</td>
                    <td><font color="red">-15.0%</font></td>
                </tr>
                <tr> 
                    <td nowrap>Currency 2</td>
                    <td>1.08</td>
                    <td>1.06</td>
                    <td><font color="red">-1.8%</font></td>
                    <td nowrap>Commodity 2</td>
                    <td>168.8</td>
                    <td>200.2</td>
                    <td><font color="green">+18.6%</font></td>
                </tr>
                <tr> 
                    <td nowrap>Currency 3</td>
                    <td>120.3</td>
                    <td>110.0</td>
                    <td><font color="red">-8.6%</font></td>
                    <td nowrap>Commodity 3</td>
                    <td>45.5</td>
                    <td>32.5</td>
                    <td><font color="red">-28.6%</font></td>
                </tr>
			</tbody>
		</table>

		<br/>
		
	</div>	<!-- .right-content -->	
	

	<!-- Filter placeholder. Actual filter selected will be added via Javascript -->
	<div id="selectFilter" class="container col-md-2"></div>
    <br/>
	

</div>	<!-- .row -->


<div id="notes" class="col-md-12">
	<br/>
	<sup>1</sup>&nbsp;Values reflect the top categories with the highest MOT.<br/>
	<sup>2</sup>&nbsp;Values reflect the top vendors with the highest MOT.<br/>
	Total MOT (US $) = <span id="tot-MOT" /><br/>
	Total Shipment Value (US $) = <span id="tot-ship" /><br/>
</div>


{% block scripts %}
{% load staticfiles %}
<link rel="stylesheet" type="text/css" href="{% static 'app/content/dc.css' %}" media="screen" /> 
<script src="{% static 'app/scripts/crossfilter.min.js' %}"></script>
<script src="{% static 'app/scripts/d3-dc.min.js' %}"></script>
<script src="{% static 'app/scripts/dc.js' %}"></script>
<script src="{% static 'app/scripts/site/common-utility.js' %}"></script> <!-- site specific filters to appear on right panel -->

<script type="text/javascript">


	/*******************************************************
	Step 0: Set up Globals
	********************************************************/
	var debugFlag = 0;
	var formatString_axis = ".2s";
	var formatString_detail = ".3s";			
	var formatFunction_axis = function(d) {return d3.format(formatString_axis)(d).replace("G","B");};
	var formatFunction_detail = function(d) {
			var colorPrefix='';
			var colorSuffix='';
			if (d < 0) {
				colorPrefix='<font color="red">';
				colorSuffix='</font>';
			}
			return colorPrefix + d3.format(formatString_detail)(snap_to_zero(d)).replace("G","B") + colorSuffix;
		};
	var formatFunction_pct = function(d) {
			var colorPrefix='';
			var colorSuffix='';
			if (d < 0) {
				colorPrefix='<font color="red">';
				colorSuffix='</font>';
               }
                     return colorPrefix + d3.format(".1%")(snap_to_zero_percent(d)) + colorSuffix;
		};

	var formatFunction_rowDetail = function(d) {
			if (snap_to_zero(d) == 0)
                    return '';
			else
                    return formatFunction_detail(d);
		};
	var formatFunction_rowPct = function(d) {
			if (snap_to_zero_percent(d) == 0)
                    return '';
			else
                    return formatFunction_pct(d);
		};
     var formatFunction_tooltips = function(d) { return d3.format(formatString_detail)(snap_to_zero(d)).replace("G","B"); };
     var formatFunction_rowLabel = function(d) {
		if (snap_to_zero(d.value.mot) == 0 && snap_to_zero(d.value.ship) == 0 )
			return '';
		else {
			var spaceLoc = d.key.indexOf(' ');
			if (spaceLoc < 0)
				return d.key;
			else
				return d.key.slice(0, spaceLoc); 
			}
		};
	var contentWidth = d3.select("#left-content").style("width").replace("px", "");
	var legend_x = 60;
	var legend_y = 10;
	var legend_itemHeight = 13;
	var legend_gap = 5;
	var num_rowsCap = 10;
	var chartTopMargin_row = -10;
	var chartWidth_row = contentWidth * 3 / 12;
	var fontSizeInUse = parseInt(d3.select("#left-content").style("font-size"));
     var perRowHeight = 17.6 / 12 * fontSizeInUse; // calculate from default setting for font-size=12px. To change font-size, modify body font-size in bootstrap.css.
	var chartHeight_row = num_rowsCap * perRowHeight;

	
	/*******************************************************
	Step 1: Prepare Data 
	********************************************************/

	var db_data = {{ data|safe }};
	if (debugFlag) {
		console.log("db_data"); console.log(db_data); // Debug
	}
	
	/*******************************************************
	Step 2: Create dc.js chart objects & link to div 
	********************************************************/

	// left hand side
	
	var totMOTChart_cat = dc.numberDisplay("#chart-tot-mot-category");
	var pctMOTChart_cat = dc.numberDisplay("#chart-pct-mot-category");
	var totValueChart_cat = dc.numberDisplay("#chart-tot-value-category");
	var pctValueChart_cat = dc.numberDisplay("#chart-pct-value-category");
	
	var catChart = dc.rowChart("#chart-category");
	var catTbl = dc.dataTable("#table-category");
	
	var sourceChart = dc.pieChart("#chart-source");
	var sourceTbl = dc.dataTable("#table-source");

	// right hand side

	var totMOTChart_vendor = dc.numberDisplay("#chart-tot-mot-vendor");
	var pctMOTChart_vendor = dc.numberDisplay("#chart-pct-mot-vendor");
	var totValueChart_vendor = dc.numberDisplay("#chart-tot-value-vendor");
	var pctValueChart_vendor = dc.numberDisplay("#chart-pct-value-vendor");
	
	var vendorChart = dc.rowChart("#chart-vendor");
	var vendorTbl = dc.dataTable("#table-vendor");

	
	/*******************************************************
	Setp 3: Set up cross filter 
	********************************************************/

	var ndx = crossfilter(db_data);

	/*******************************************************
	Setp 4: Create dimensions
	A dimention is something to group or filter by.
	Crossfilter can filter by exact value or by range.
	********************************************************/

	// add
	var reduceAdd_Fn = function(p, v) {
			p.ship +=  v.fields.sum_shipment_value;
			p.tsp_valueGrowth += v.fields.TSP_ValueGrowth;
			p.tsp_moq += v.fields.TSP_MOQ;
			p.tsp_costpricerecovery += v.fields.TSP_CostPriceRecovery;
			p.mot += v.fields.TSP_MOT;
			return p;
		};
	// remove
	var reduceRemove_Fn = function(p, v) {
			p.ship -=  v.fields.sum_shipment_value;
			p.tsp_valueGrowth -= v.fields.TSP_ValueGrowth;
			p.tsp_moq -= v.fields.TSP_MOQ;
			p.tsp_costpricerecovery -= v.fields.TSP_CostPriceRecovery;
			p.mot -= v.fields.TSP_MOT;
			return p;
		};
	// init
	var reduceInit_Fn = function() {
			return {ship: 0, tsp_valueGrowth: 0, tsp_moq: 0, tsp_costpricerecovery: 0, mot: 0};
			};
			
	var orderFunction_rowChart = function(d) { 
				var rtn = snap_to_zero(d.value.mot); 
				if (rtn == 0)
					rtn = -999999999999;
				return -rtn; };
	var orderFunction_dataTable = function(d) { 
				var rtn = snap_to_zero(d.value.mot); 
				if (rtn == 0)
					rtn = -999999999999;
				return rtn; };
	var orderFunction_dimension = function(d) { 
				var rtn = snap_to_zero(d.mot); 
				if (rtn == 0)
					rtn = -999999999999;
				return rtn; };

	var mot_grouped_dim = ndx.groupAll().reduce(reduceAdd_Fn, reduceRemove_Fn, reduceInit_Fn);
	var tot_ship = snap_to_zero(mot_grouped_dim.value().ship);
	var tot_mot = snap_to_zero(mot_grouped_dim.value().mot);
	
	var catDim = ndx.dimension(function(d) {return d.fields.category;});
	var cat_grouped_dim = catDim.group().reduce(reduceAdd_Fn, reduceRemove_Fn, reduceInit_Fn).order(orderFunction_dimension);

	var shipVal_catgroup=catDim.group().reduceSum(function(d) {return d.fields.sum_shipment_value;});

	var sourceDim = ndx.dimension(function(d) {return d.fields.buying_office;});
	var shipVal_sourcegroup=sourceDim.group().reduce(reduceAdd_Fn, reduceRemove_Fn, reduceInit_Fn).order(function(d) { return d.mot });;


	var vendorDim = ndx.dimension(function(d) {return d.fields.vendor_code;});
	var vendor_grouped_dim = vendorDim.group().reduce(reduceAdd_Fn, reduceRemove_Fn, reduceInit_Fn).order(orderFunction_dimension);
	
	
	/*******************************************************
	Step 5: Create Main Charts for Visualization
	********************************************************/

	d3.select("#tot-MOT").html(function(d, i) {return formatFunction_detail(tot_mot)} );
	d3.select("#tot-ship").html(function(d, i) {return formatFunction_detail(tot_ship)} );
	
	// left hand side
	
	totMOTChart_cat
		.group(mot_grouped_dim)
		.valueAccessor(function(d) {
				var tot = 0; 
				for (var i=0; i<num_rowsCap; i++) {
					tot += cat_grouped_dim.top(num_rowsCap)[i].value.mot;
				}; 
				return snap_to_zero(tot); 
			})
		.formatNumber(formatFunction_detail);
		;
	pctMOTChart_cat
		.group(mot_grouped_dim)
		.valueAccessor(function(d) {
				var tot = 0; 
				for (var i=0; i<num_rowsCap; i++) {
					tot += cat_grouped_dim.top(num_rowsCap)[i].value.mot;
				}; 
				return (tot_mot == 0) ? 0 : (snap_to_zero(tot) / tot_mot); 
			})
		.formatNumber(formatFunction_pct);
		;
	
	totValueChart_cat
		.group(mot_grouped_dim)
		.valueAccessor(function(d) {
				var tot = 0; 
				for (var i=0; i<num_rowsCap; i++) {
					tot += cat_grouped_dim.top(num_rowsCap)[i].value.ship;
				}; 
				return snap_to_zero(tot); 
			})
		.formatNumber(formatFunction_detail);
		;
	
	pctValueChart_cat
		.group(mot_grouped_dim)
		.valueAccessor(function(d) {
				var tot = 0; 
				for (var i=0; i<num_rowsCap; i++) {
					tot += cat_grouped_dim.top(num_rowsCap)[i].value.ship;
				}; 
				return (tot_ship == 0) ? 0 : (snap_to_zero(tot) / tot_ship); 
			})
		.formatNumber(formatFunction_pct);
		;

	// Category row chart
	catChart
		.width(chartWidth_row) 
		.height(chartHeight_row) 
		.x(d3.scale.linear()) 
		.elasticX(true) 
		.dimension(catDim) 
		.group(cat_grouped_dim)
		.valueAccessor(function(d) {return snap_to_zero(d.value.mot)}) 
		.ordering(orderFunction_rowChart)
		.rowsCap(num_rowsCap)
		.othersGrouper(false) 
		.xAxis().ticks(0)
		; 

				
	
	catChart.label(function (d) {return '';});
	catChart.title(function(d) { return d.key + ": " + formatFunction_tooltips(d.value.mot); });
	catChart.margins().top = catChart.margins().top + chartTopMargin_row;
	catChart.margins().bottom = -5;
	catChart.margins().left = 0;
	catChart.margins().right = 50;
    
    

	catTbl
		.dimension(cat_grouped_dim)
		.group(function (p) { return "" })
		.columns([
                formatFunction_rowLabel,
//			function(d) { return d.key; },
			function(d) { return formatFunction_rowDetail(d.value.mot); },
			function(d) { return formatFunction_rowPct(d.value.mot / tot_mot); },
			function(d) { return formatFunction_rowDetail(d.value.ship); },
			function(d) { return formatFunction_rowPct(d.value.ship / tot_ship); },
		])
		.sortBy(orderFunction_dataTable)
		.order(d3.descending)
		.showGroups(false)
		.endSlice(num_rowsCap)
		;

		
	// Sourcing
	sourceChart
		.width(chartWidth_row)
		.height(chartWidth_row)
		.dimension(sourceDim)
		.group(shipVal_sourcegroup)
		.valueAccessor(function(d) {return snap_to_zero(d.value.ship);})
		.innerRadius(10)
		;

	sourceTbl
		.dimension(shipVal_sourcegroup)
		.group(function (p) { return "" })
		.columns([
			function(d) { return d.key; },
			function(d) { return formatFunction_detail(d.value.ship); }
		])
		.sortBy(function (d) { return d.value })
		.order(d3.descending)
		.showGroups(false)
		;


	// right hand side
	
	totMOTChart_vendor
		.group(mot_grouped_dim)
		.valueAccessor(function(d) {
				var tot = 0; 
				for (var i=0; i<num_rowsCap; i++) {
					tot += vendor_grouped_dim.top(num_rowsCap)[i].value.mot;
				}; 
				return snap_to_zero(tot); 
			})
		.formatNumber(formatFunction_detail);
		;
	pctMOTChart_vendor
		.group(mot_grouped_dim)
		.valueAccessor(function(d) {
				var tot = 0; 
				for (var i=0; i<num_rowsCap; i++) {
					tot += vendor_grouped_dim.top(num_rowsCap)[i].value.mot;
				}; 
				return (tot_mot == 0) ? 0 : (snap_to_zero(tot) / tot_mot); 
			})
		.formatNumber(formatFunction_pct);
		;
	
	totValueChart_vendor
		.group(mot_grouped_dim)
		.valueAccessor(function(d) {
				var tot = 0; 
				for (var i=0; i<num_rowsCap; i++) {
					tot += vendor_grouped_dim.top(num_rowsCap)[i].value.ship;
				}; 
				return snap_to_zero(tot); 
			})
		.formatNumber(formatFunction_detail);
		;
	
	pctValueChart_vendor
		.group(mot_grouped_dim)
		.valueAccessor(function(d) {
				var tot = 0; 
				for (var i=0; i<num_rowsCap; i++) {
					tot += vendor_grouped_dim.top(num_rowsCap)[i].value.ship;
				}; 
				return (tot_ship == 0) ? 0 : (snap_to_zero(tot) / tot_ship); 
			})
		.formatNumber(formatFunction_pct);
		;

		

	// vendor row chart
	vendorChart
		.width(chartWidth_row) 
		.height(chartHeight_row) 
		.x(d3.scale.linear()) 
		.elasticX(true) 
		.dimension(vendorDim) 
		.group(vendor_grouped_dim)
		.valueAccessor(function(d) {return snap_to_zero(d.value.mot)}) 
		.ordering(orderFunction_rowChart)
		.rowsCap(num_rowsCap)
		.othersGrouper(false) 
		.xAxis().ticks(0)
		; 
	
	vendorChart.label(function (d) {return '';});
	vendorChart.title(function(d) { return d.key + ": " + formatFunction_tooltips(d.value.mot); });
	vendorChart.margins().top = vendorChart.margins().top + chartTopMargin_row;
	vendorChart.margins().bottom = -5;
	vendorChart.margins().left = 0;
	vendorChart.margins().right = 50;

	vendorTbl
		.dimension(vendor_grouped_dim)
		.group(function (p) { return "" })
		.columns([
			formatFunction_rowLabel,
//			function(d) { return d.key; },
			function(d) { return formatFunction_rowDetail(d.value.mot); },
			function(d) { return formatFunction_rowPct(d.value.mot / tot_mot); },
			function(d) { return formatFunction_rowDetail(d.value.ship); },
			function(d) { return formatFunction_rowPct(d.value.ship / tot_ship); },
		])
		.sortBy(orderFunction_dataTable)
		.order(d3.descending)
		.showGroups(false)
		.endSlice(num_rowsCap)
		;

		

		
	/*******************************************************
	Step 6: Set up Side Panel Filters
	********************************************************/

	var showFilters = {{ filters|safe }};
	setupFilter(ndx, showFilters);

		
	/*******************************************************
	Step 7: Render the Charts
	********************************************************/

	dc.renderAll();

	
</script>
{% endblock %}
	
