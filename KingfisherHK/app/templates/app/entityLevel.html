<div class="row">
	<!--div id="content" class="container col-md-9">
		<h1>{{ title }}</h1>
	</div-->
	<div id="left-content" class="container col-md-5">
	
		<h1>Money On the Table by Category</h1>
		<div class="row">
			<table>
				<tbody>
					<tr>
						<td style="border-left: 1px solid #cdd0d4; border-top: 1px solid #cdd0d4; border-bottom: 1px solid #cdd0d4;">Money On the Table (US $)<sup>1</sup></td>
						<td style="border-right: 1px solid #cdd0d4; border-top: 1px solid #cdd0d4; border-bottom: 1px solid #cdd0d4; background-color:orange" align="center">&nbsp;<strong><span id="chart-tot-mot-category" align="center"></strong>&nbsp;</td>
						<td style="border-left: 1px solid #cdd0d4; border-top: 1px solid #cdd0d4; border-bottom: 1px solid #cdd0d4;">Shipment Value (US $)<sup>1</sup></td align="center">
						<td style="border-right: 1px solid #cdd0d4; border-top: 1px solid #cdd0d4; border-bottom: 1px solid #cdd0d4; background-color:orange">&nbsp;<strong><span id="chart-tot-value-category"></strong>&nbsp;</td>
					</tr>
					<tr>
						<td style="border-left: 1px solid #cdd0d4; border-top: 1px solid #cdd0d4; border-bottom: 1px solid #cdd0d4;">Share of Total MOT<sup>1</sup></td>
						<td style="border-right: 1px solid #cdd0d4; border-top: 1px solid #cdd0d4; border-bottom: 1px solid #cdd0d4; background-color:orange" align="center">&nbsp;<strong><span id="chart-pct-mot-category"></strong>&nbsp;</td>
						<td style="border-left: 1px solid #cdd0d4; border-top: 1px solid #cdd0d4; border-bottom: 1px solid #cdd0d4;">Share of Total Ship. Value<sup>1</sup></td>
						<td style="border-right: 1px solid #cdd0d4; border-top: 1px solid #cdd0d4; border-bottom: 1px solid #cdd0d4; background-color:orange" align="center">&nbsp;<strong><span id="chart-pct-value-category"></strong>&nbsp;</td>
					</tr>
				</tbody>
			</table>
		</div>

		<div class="row">
			<span id="chart-category" class="col-md-4"></span>
			<span class="col-md-8">
				<table id="table-category" class="table table-sm table-hover table-responsive table-striped">
					<thead>
					<tr > <!--class="header">-->
						<th>MOT (US $)</th>
						<th>Share of Total MOT (%)</th>
						<th>Ship. Value (US $)</th>
						<th>Share of Total Ship. Value (%)</th>
					</tr>
					</thead>
				</table>
			</span>
		</div>
		
		<h1>Contribution by Different Sourcing Office</h1>
		<div>
			<span id="chart-source" class="col-md-4"></span>
			<span class="col-md-8">
				<table id="table-source" class="table table-sm table-hover table-responsive table-striped">
					<thead>
					<tr> <!--class="header">-->
						<th>Source</th>
						<th>Ship. Value (US $)</th>
					</tr>
					</thead>
				</table>
			</span>
		</div>
	
	</div>	<!-- .left-content -->

	
	<div id="right-content" class="container col-md-5">
	
		<h1>Money On the Table - Top Vendors</h1>
		<div class="row">
			<table>
				<tbody>
					<tr>
						<td style="border-left: 1px solid #cdd0d4; border-top: 1px solid #cdd0d4; border-bottom: 1px solid #cdd0d4;">Money On the Table (US $)<sup>2</sup></td>
						<td style="border-right: 1px solid #cdd0d4; border-top: 1px solid #cdd0d4; border-bottom: 1px solid #cdd0d4; background-color:orange" align="center">&nbsp;<strong><span id="chart-tot-mot-vendor"></strong>&nbsp;</td>
						<td style="border-left: 1px solid #cdd0d4; border-top: 1px solid #cdd0d4; border-bottom: 1px solid #cdd0d4;">Shipment Value (US $)<sup>2</sup></td>
						<td style="border-right: 1px solid #cdd0d4; border-top: 1px solid #cdd0d4; border-bottom: 1px solid #cdd0d4; background-color:orange" align="center">&nbsp;<strong><span id="chart-tot-value-vendor"></strong>&nbsp;</td>
					</tr>
					<tr>
						<td style="border-left: 1px solid #cdd0d4; border-top: 1px solid #cdd0d4; border-bottom: 1px solid #cdd0d4;">Share of Total MOT<sup>2</sup></td>
						<td style="border-right: 1px solid #cdd0d4; border-top: 1px solid #cdd0d4; border-bottom: 1px solid #cdd0d4; background-color:orange" align="center">&nbsp;<strong><span id="chart-pct-mot-vendor"></strong>&nbsp;</td>
						<td style="border-left: 1px solid #cdd0d4; border-top: 1px solid #cdd0d4; border-bottom: 1px solid #cdd0d4;">Share of Total Ship. Value<sup>2</sup></td>
						<td style="border-right: 1px solid #cdd0d4; border-top: 1px solid #cdd0d4; border-bottom: 1px solid #cdd0d4; background-color:orange" align="center">&nbsp;<strong><span id="chart-pct-value-vendor"></strong>&nbsp;</td>
					</tr>
				</tbody>
			</table>
		</div>

		<div class="row">
			<span id="chart-vendor" class="col-md-4"></span>
			<span class="col-md-8">
				<table id="table-vendor" class="table table-sm table-hover table-responsive table-striped">
					<thead>
					<tr > <!--class="header">-->
						<th>MOT (US $)</th>
						<th>Share of Total MOT (%)</th>
						<th>Ship. Value (US $)</th>
						<th>Share of Total Ship. Value (%)</th>
					</tr>
					</thead>
				</table>
			</span>
		</div>
		
		
		<h1>Key Commodities Movement</h1>
		<table id="chart-currency-commodity" class="table table-hover table-responsive table-striped">
			<thead>
			<tr > 
				<th></th>
				<th></th>
				<th></th>
				<th>Currency</th>
				<th></th>
				<th></th>
				<th></th>
				<th>Commodities</th>
			</tr>
			<tr > 
				<th></th>
				<th>2015.06</th>
				<th>2016.06</th>
				<th>YoY%</th>
				<th></th>
				<th>2015.06</th>
				<th>2016.06</th>
				<th>YoY%</th>
			</tr>
			</thead>
			<tbody>
			<tr > 
				<td>Currency 1</td>
				<td>7.74</td>
				<td>7.76</td>
				<td><font color="green">+0.3%</font></td>
				<td>Commodity 1</td>
				<td>800.2</td>
				<td>680.2</td>
				<td><font color="red">-15.0%</font></td>
			</tr>
			<tr > 
				<td>Currency 2</td>
				<td>1.08</td>
				<td>1.06</td>
				<td><font color="red">-1.8%</font></td>
				<td>Commodity 2</td>
				<td>168.8</td>
				<td>200.2</td>
				<td><font color="green">+18.6%</font></td>
			</tr>
			<tr > 
				<td>Currency 3</td>
				<td>120.3</td>
				<td>110.0</td>
				<td><font color="red">-8.6%</font></td>
				<td>Commodity 3</td>
				<td>45.5</td>
				<td>32.5</td>
				<td><font color="red">-28.6%</font></td>
			</tr>
			</tbody>
		</table>

	
	</div>	<!-- .right-content -->	
	

	<!-- Filter placeholder. Actual filter selected will be added via Javascript -->
	<div id="selectFilter" class="container col-md-2"></div>

</div>	<!-- .row -->


<div id="notes" class="col-md-12">
	<sup>1</sup>&nbsp;Values reflect the top categories with the highest MOT.<br/>
	<sup>2</sup>&nbsp;Values reflect the top vendors with the highest MOT.<br/>
</div>

<div id="tbd" class="col-md-12">
	<br/>
	<br/>
	<h3>The following items are yet to be developed:</h3>
	<li>category labels in black</li>
</div>	<!-- .tbd -->


{% block scripts %}
{% load staticfiles %}
<link rel="stylesheet" type="text/css" href="{% static 'app/content/dc.min.css' %}" media="screen" /> 
<script src="{% static 'app/scripts/crossfilter.min.js' %}"></script>
<script src="{% static 'app/scripts/d3-dc.min.js' %}"></script>
<script src="{% static 'app/scripts/dc.min.js' %}"></script>
<script src="{% static 'app/scripts/site/common-utility.js' %}"></script> <!-- site specific filters to appear on right panel -->

<script type="text/javascript">


	/*******************************************************
	Step 0: Set up Globals
	********************************************************/
	var debugFlag = 0;
	var formatString_axis = ".2s";
	var formatString_detail = ".3s";			
	var formatFunction_axis = function(d) {return d3.format(formatString_axis)(d).replace("G","B");};
	var formatFunction_detail = function(d) {return d3.format(formatString_detail)(d).replace("G","B");};
	var formatFunction_pct = d3.format("%");
	var contentWidth = d3.select("#left-content").style("width").replace("px", "");
	var legend_x = 60;
	var legend_y = 10;
	var legend_itemHeight = 13;
	var legend_gap = 5;
	var num_rowsCap = 10;
	var chartTopMargin_row = 85;
	var chartWidth_row = contentWidth * 0.4;
	var chartHeight_row = num_rowsCap * 42 + chartTopMargin_row;

	
	/*******************************************************
	Step 1: Prepare Data 
	********************************************************/

	var db_data = {{ data|safe }};
	if (debugFlag) {
		console.log("db_data"); console.log(db_data); // Debug
	}
	
	/*******************************************************
	Step 2: Create dc.js chart objects & link to div 
	********************************************************/

	// left hand side
	
	var totMOTChart_cat = dc.numberDisplay("#chart-tot-mot-category");
	var pctMOTChart_cat = dc.numberDisplay("#chart-pct-mot-category");
	var totValueChart_cat = dc.numberDisplay("#chart-tot-value-category");
	var pctValueChart_cat = dc.numberDisplay("#chart-pct-value-category");
	
	var catChart = dc.rowChart("#chart-category");
	var catTbl = dc.dataTable("#table-category");
	
	var sourceChart = dc.pieChart("#chart-source");
	var sourceTbl = dc.dataTable("#table-source");

	// right hand side

	var totMOTChart_vendor = dc.numberDisplay("#chart-tot-mot-vendor");
	var pctMOTChart_vendor = dc.numberDisplay("#chart-pct-mot-vendor");
	var totValueChart_vendor = dc.numberDisplay("#chart-tot-value-vendor");
	var pctValueChart_vendor = dc.numberDisplay("#chart-pct-value-vendor");
	
	var vendorChart = dc.rowChart("#chart-vendor");
	var vendorTbl = dc.dataTable("#table-vendor");

	
	/*******************************************************
	Setp 3: Set up cross filter 
	********************************************************/

	var ndx = crossfilter(db_data);

	/*******************************************************
	Setp 4: Create dimensions
	A dimention is something to group or filter by.
	Crossfilter can filter by exact value or by range.
	********************************************************/

	// add
	var reduceAdd_Fn = function(p, v) {
			p.ship +=  +v.fields.sum_shipment_value;
			p.tsp_valueGrowth += v.fields.TSP_ValueGrowth;
			p.tsp_moq += v.fields.TSP_MOQ;
			p.tsp_costpricerecovery += 0;
			p.mot = p.tsp_valueGrowth + p.tsp_moq + p.tsp_costpricerecovery;
			return p;
		};
	// remove
	var reduceRemove_Fn = function(p, v) {
			p.ship -=  +v.fields.sum_shipment_value;
			p.tsp_valueGrowth -= v.fields.TSP_ValueGrowth;
			p.tsp_moq -= v.fields.TSP_MOQ;
			p.tsp_costpricerecovery -= 0;
			p.mot = p.tsp_valueGrowth + p.tsp_moq + p.tsp_costpricerecovery;
			return p;
		};
	// init
	var reduceInit_Fn = function() {
			return {ship: 0, tsp_valueGrowth: 0, tsp_moq: 0, tsp_costpricerecovery: 0};
			};
			
	var mot_grouped_dim = ndx.groupAll().reduce(reduceAdd_Fn, reduceRemove_Fn, reduceInit_Fn);
	var tot_ship = mot_grouped_dim.value().ship;
	var tot_mot = mot_grouped_dim.value().mot;
	
	var catDim = ndx.dimension(function(d) {return d.fields.category;});
	var cat_grouped_dim = catDim.group().reduce(reduceAdd_Fn, reduceRemove_Fn, reduceInit_Fn).order(function(d) { return d.mot });

	var shipVal_catgroup=catDim.group().reduceSum(function(d) {return d.fields.sum_shipment_value;});

	var sourceDim = ndx.dimension(function(d) {return d.fields.buying_office;});
	var shipVal_sourcegroup=sourceDim.group().reduce(reduceAdd_Fn, reduceRemove_Fn, reduceInit_Fn).order(function(d) { return d.mot });;


	var vendorDim = ndx.dimension(function(d) {return d.fields.vendor_code;});
	var vendor_grouped_dim = vendorDim.group().reduce(reduceAdd_Fn, reduceRemove_Fn, reduceInit_Fn).order(function(d) { return d.mot });
	
	
	/*******************************************************
	Step 5: Create Main Charts for Visualization
	********************************************************/
	
	// left hand side
	
	totMOTChart_cat
		.group(mot_grouped_dim)
//		.valueAccessor(function(d) {return Math.abs(d.mot) < 0.1 ? 0 : d.mot; })
		.valueAccessor(function(d) {
				var tot = 0; 
				for (var i=0; i<num_rowsCap; i++) {
					tot += cat_grouped_dim.top(num_rowsCap)[i].value.mot;
				}; 
				return Math.abs(tot) < 1 ? 0 : tot; 
			})
		.formatNumber(formatFunction_detail);
		;
	pctMOTChart_cat
		.group(mot_grouped_dim)
//		.valueAccessor(function(d) {return d.mot / tot_mot; })
		.valueAccessor(function(d) {
				var tot = 0; 
				for (var i=0; i<num_rowsCap; i++) {
					tot += cat_grouped_dim.top(num_rowsCap)[i].value.mot;
				}; 
				return (tot_mot == 0) ? 0 : (tot / tot_mot); 
			})
		.formatNumber(formatFunction_pct);
		;
	
	totValueChart_cat
		.group(mot_grouped_dim)
//		.valueAccessor(function(d) {return Math.abs(d.ship) < 1 ? 0 : d.ship;})
		.valueAccessor(function(d) {
				var tot = 0; 
				for (var i=0; i<num_rowsCap; i++) {
					tot += cat_grouped_dim.top(num_rowsCap)[i].value.ship;
				}; 
				return Math.abs(tot) < 1 ? 0 : tot; 
			})
		.formatNumber(formatFunction_detail);
		;
	
	pctValueChart_cat
		.group(mot_grouped_dim)
//		.valueAccessor(function(d) {return d.ship / tot_ship; })
		.valueAccessor(function(d) {
				var tot = 0; 
				for (var i=0; i<num_rowsCap; i++) {
					tot += cat_grouped_dim.top(num_rowsCap)[i].value.ship;
				}; 
				return (tot_ship == 0) ? 0 : (tot / tot_ship); 
			})
		.formatNumber(formatFunction_pct);
		;

	// Category row chart
	catChart
		.width(chartWidth_row) 
		.height(chartHeight_row) 
		.x(d3.scale.linear()) 
		.elasticX(true) 
		.dimension(catDim) 
		.group(cat_grouped_dim)
		.valueAccessor(function(d) {return d.value.mot}) 
		.ordering(function(d) { return -d.value.mot })
		.rowsCap(num_rowsCap)
		.othersGrouper(false) 
		.xAxis().ticks(0)
//		.xAxis().tickFormat(function(v) {return "";})
		; 
//	catChart.title().attr("style", "fill: #999999")
	catChart.margins().top = catChart.margins().top + chartTopMargin_row;

	catTbl
		.dimension(cat_grouped_dim)
		.group(function (p) { return "" })
		.columns([
//			function(d) { return d.key; },
			function(d) { return formatFunction_detail(d.value.mot); },
			function(d) { return formatFunction_pct(d.value.mot / tot_mot); },
			function(d) { return formatFunction_detail(d.value.ship); },
			function(d) { return formatFunction_pct(d.value.ship / tot_ship); },
		])
		.sortBy(function (d) { return d.value.mot })
		.order(d3.descending)
		.showGroups(false)
		.endSlice(num_rowsCap)
		;

		
	// Sourcing
	sourceChart
		.width(chartWidth_row * 3/4)
		.height(chartWidth_row)
		.dimension(sourceDim)
		.group(shipVal_sourcegroup)
		.valueAccessor(function(d) {return Math.abs(d.value.ship) < 1 ? 0 : d.value.ship;})
		.innerRadius(10)
		;

	sourceTbl
		.dimension(shipVal_sourcegroup)
		.group(function (p) { return "" })
		.columns([
			function(d) { return d.key; },
			function(d) { return formatFunction_detail(d.value.ship); }
		])
		.sortBy(function (d) { return d.value })
		.order(d3.descending)
		.showGroups(false)
		;


	// right hand side
	
	totMOTChart_vendor
		.group(mot_grouped_dim)
//		.valueAccessor(function(d) {return Math.abs(d.mot) < 0.1 ? 0 : d.mot; })
		.valueAccessor(function(d) {
				var tot = 0; 
				for (var i=0; i<num_rowsCap; i++) {
					tot += vendor_grouped_dim.top(num_rowsCap)[i].value.mot;
				}; 
				return Math.abs(tot) < 1 ? 0 : tot; 
			})
		.formatNumber(formatFunction_detail);
		;
	pctMOTChart_vendor
		.group(mot_grouped_dim)
//		.valueAccessor(function(d) {return d.mot / tot_mot; })
		.valueAccessor(function(d) {
				var tot = 0; 
				for (var i=0; i<num_rowsCap; i++) {
					tot += vendor_grouped_dim.top(num_rowsCap)[i].value.mot;
				}; 
				return (tot_mot == 0) ? 0 : (tot / tot_mot); 
			})
		.formatNumber(formatFunction_pct);
		;
	
	totValueChart_vendor
		.group(mot_grouped_dim)
//		.valueAccessor(function(d) {return Math.abs(d.ship) < 1 ? 0 : d.ship;})
		.valueAccessor(function(d) {
				var tot = 0; 
				for (var i=0; i<num_rowsCap; i++) {
					tot += vendor_grouped_dim.top(num_rowsCap)[i].value.ship;
				}; 
				return Math.abs(tot) < 1 ? 0 : tot; 
			})
		.formatNumber(formatFunction_detail);
		;
	
	pctValueChart_vendor
		.group(mot_grouped_dim)
//		.valueAccessor(function(d) {return d.ship / tot_ship; })
		.valueAccessor(function(d) {
				var tot = 0; 
				for (var i=0; i<num_rowsCap; i++) {
					tot += vendor_grouped_dim.top(num_rowsCap)[i].value.ship;
				}; 
				return (tot_ship == 0) ? 0 : (tot / tot_ship); 
			})
		.formatNumber(formatFunction_pct);
		;

		

	// vendor row chart
	vendorChart
		.width(chartWidth_row) 
		.height(chartHeight_row) 
		.x(d3.scale.linear()) 
		.elasticX(true) 
		.dimension(vendorDim) 
		.group(vendor_grouped_dim)
		.valueAccessor(function(d) {return d.value.mot}) 
		.ordering(function(d) { return -d.value.mot })
		.rowsCap(num_rowsCap)
		.othersGrouper(false) 
		.xAxis().ticks(0)
//		.xAxis().tickFormat(function(v) {return "";})
		; 
	vendorChart.margins().top = vendorChart.margins().top + chartTopMargin_row;

	vendorTbl
		.dimension(vendor_grouped_dim)
		.group(function (p) { return "" })
		.columns([
//			function(d) { return d.key; },
			function(d) { return formatFunction_detail(d.value.mot); },
			function(d) { return formatFunction_pct(d.value.mot / tot_mot); },
			function(d) { return formatFunction_detail(d.value.ship); },
			function(d) { return formatFunction_pct(d.value.ship / tot_ship); },
		])
//		.sortBy(function (d) { return d.value.mot })
		.order(d3.descending)
		.showGroups(false)
		.endSlice(num_rowsCap)
		;

		

		
	/*******************************************************
	Step 6: Set up Side Panel Filters
	********************************************************/

	var showFilters = {{ filters|safe }};
	setupFilter(ndx, showFilters);

		
	/*******************************************************
	Step 7: Render the Charts
	********************************************************/

	dc.renderAll();

	
</script>
{% endblock %}
	