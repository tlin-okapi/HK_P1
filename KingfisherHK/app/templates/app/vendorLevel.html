<div class="row" style="border-bottom: 1px solid #dddddd;">
	<!--div id="content" class="container col-md-9">
		<h1>{{ title }}</h1>
	</div-->
	<div id="left-content" class="container col-md-5" style="border-right: 1px solid #dddddd;">
		
		<h1>Business Performance Overview</h1>
        <br/>

		<div class="row">
			<span id="chart-category-dummy" class="col-md-2"></span>
			<span class="col-md-10">
				<table id="table-category-dummy" class="table table-condensed table-hover table-responsive table-striped col-md-3">
                    <col width="150px">
                    <col width="150px">
                    <col width="150px">
                    <col width="150px">
					<thead>
					<tr>
						<th>&nbsp;&nbsp;&nbsp;Category&nbsp;&nbsp;&nbsp;</th>
						<th>Ship. Value <br/>(US $)</th>
						<th>Share of Total Ship. Value (%)</th>
						<th>Ship. Volume (Units)</th>
					</tr>
					</thead>
				</table>
			</span>
		</div>

		<div class="row">
			<span id="chart-category" class="col-md-2"></span>
			<span class="col-md-10">
				<table id="table-category" class="table table-condensed table-hover table-responsive table-striped col-md-3">
                    <col width="150px">
                    <col width="150px">
                    <col width="150px">
                    <col width="150px">
					<tbody>
					</tbody>
				</table>
			</span>
		</div>
		
		<div id="chart-shipment">
			<h2 align="center">Shipment Value & Volume</h2>
		</div>
		
		<div id="chart-avg-cost">
			<h2 align="center">Average Cost Price</h2>
		</div>

        <br/>
        <br/>
		<div id="data-table" style='clear:both;'>
			<h2 align="center"><br/>Average Value and Volume</h2>
            <table id="chart-avg-value-vol" class="table table-condensed table-hover table-responsive table-striped">
                <thead>
                <tr>
                    <th style=" font-size:12px">Year</th>
                    <th style="width:150px; font-size:12px">Avg. Value per <br/>SKU (US $)</th>
                    <th  style="width:150px; font-size:12px">Avg. Value per <br>PO (US $)</th>
                    <th  style="width:150px; font-size:12px">Avg. Volume per <br>SKU (US $)</th>
                    <th  style="width:150px; font-size:12px">Avg. Volume per <br>PO (US $)</th>
                </tr>
                </thead>
            </table>
		</div>	<!-- .data-table -->
		
        <br/>
		

		
	</div>	<!-- .left-content -->

	<div id="right-content" class="container col-md-5" style="border-left: 1px solid #dddddd; border-right: 1px solid #dddddd;">
		
		<h1>Money On the Table Summary</h1>
        <br/>
        <br/>
        <br/>
        <table>
            <tbody>
                <tr>
                    <td style="border-left: 1px solid #cdd0d4; border-top: 1px solid #cdd0d4; border-bottom: 1px solid #cdd0d4; text-align: center">Shipment Value (US $)<sup>1</sup></td>
                    <td style="border-right: 1px solid #cdd0d4; border-top: 1px solid #cdd0d4; border-bottom: 1px solid #cdd0d4; background-color:orange; text-align: center">&nbsp;<strong><span id="chart-tot-value"></strong>&nbsp;</td>
                    <td style="border-left: 1px solid #cdd0d4; border-top: 1px solid #cdd0d4; border-bottom: 1px solid #cdd0d4; text-align: center">Money On the Table (US $)<sup>1</sup></td>
                    <td style="border-right: 1px solid #cdd0d4; border-top: 1px solid #cdd0d4; border-bottom: 1px solid #cdd0d4; background-color:orange; text-align: center">&nbsp;<strong><span id="chart-tot-mot"></strong>&nbsp;</td>
                    <td style="border-left: 1px solid #cdd0d4; border-top: 1px solid #cdd0d4; border-bottom: 1px solid #cdd0d4; text-align: center">MOQ% of Shipment Value</td>
                    <td style="border-right: 1px solid #cdd0d4; border-top: 1px solid #cdd0d4; border-bottom: 1px solid #cdd0d4; background-color:orange; text-align: center">&nbsp;<strong><span id="chart-tot-moq"></strong>&nbsp;</td>
                </tr>
                <tr>
                    <td style="border-left: 1px solid #cdd0d4; border-top: 1px solid #cdd0d4; border-bottom: 1px solid #cdd0d4; text-align: center">Share of Total <br/>Ship. Value<sup>1</sup></td>
                    <td style="border-right: 1px solid #cdd0d4; border-top: 1px solid #cdd0d4; border-bottom: 1px solid #cdd0d4; background-color:orange; text-align: center">&nbsp;<strong><span id="chart-pct-value"></strong>&nbsp;</td>
                    <td style="border-left: 1px solid #cdd0d4; border-top: 1px solid #cdd0d4; border-bottom: 1px solid #cdd0d4; text-align: center">Share of Total <br/>MOT<sup>1</sup></td>
                    <td style="border-right: 1px solid #cdd0d4; border-top: 1px solid #cdd0d4; border-bottom: 1px solid #cdd0d4; background-color:orange; text-align: center">&nbsp;<strong><span id="chart-pct-mot"></strong>&nbsp;</td>
                </tr>
            </tbody>
        </table>
        
        <br/>
		<br/>
        <br/>
		<br/>
        <br/>
 
		<div id="data-table" style='clear:both;'>
				<table id="chart-avg-value-vol" class="table table-condensed table-hover table-responsive table-striped">
					<thead>
					<tr> <!--class="header">-->
						<th></th>
						<th>MOT <br/>(US $)</th>
						<th>Share of <br/>MOT (%)</th>
						<th>Potential <br/>Negotiation Lever</th>
					</tr>
					</thead>
					<tbody>
					<tr id="mot-table-valuegrowth" style="display: table-row;">
						<td>Value Growth</td>
						<td id="mot-table-valuegrowth-value"></td>
						<td id="mot-table-valuegrowth-pct"></td>
						<td>Tooling, amortization, <br/>overhead</td>
					</tr>
					<tr id="mot-table-moq" style="display: table-row;">
						<td>MOQ</td>
						<td id="mot-table-moq-value"></td>
						<td id="mot-table-moq-pct"></td>
						<td>Encash the unused <br/>flexibility, lower FoB</td>
					</tr>
					<tr id="mot-table-cpr" style="display: none;">
						<td>Cost Price Recovery</td>
						<td id="mot-table-cpr-value"></td>
						<td id="mot-table-cpr-pct"></td>
						<td>Commodity driven; wage rate; productivity; T2 cost management</td>
					</tr>
					<tr id="mot-table-leadtime" style="display: none;">
						<td>Lead Time</td>
						<td id="mot-table-leadtime-value"></td>
						<td id="mot-table-leadtime-pct"></td>
						<td>&nbsp;<br/>&nbsp;</td>
					</tr>
					<tr id="mot-table-margin" style="display: none;">
						<td>Margin</td>
						<td id="mot-table-margin-value"></td>
						<td id="mot-table-margin-pct"></td>
						<td>&nbsp;<br/>&nbsp;</td>
					</tr>
					</tbody>
				</table>
				<table id="chart-avg-value-vol-blank" class="table table-condensed table-responsive" border="0">
					<tr id="mot-table-valuegrowth-blank" style="display: none;" bgcolor="#FFFFFF">
						<td/><td/><td/>
						<td>&nbsp;<br/>&nbsp;</td>
					</tr>
					<tr id="mot-table-moq-blank" style="display: none;" bgcolor="#FFFFFF">
						<td/><td/><td/>
						<td>&nbsp;<br/>&nbsp;</td>
					</tr>
					<tr id="mot-table-cpr-blank" style="display: table-row;" bgcolor="#FFFFFF">
						<td/><td/><td/>
						<td>&nbsp;<br/>&nbsp;</td>
					</tr>
					<tr id="mot-table-leadtime-blank" style="display: table-row;" bgcolor="#FFFFFF">
						<td/><td/><td/>
						<td>&nbsp;<br/>&nbsp;</td>
					</tr>
					<tr id="mot-table-margin-blank" style="display: table-row;" bgcolor="#FFFFFF">
						<td/><td/><td/>
						<td>&nbsp;<br/>&nbsp;</td>
					</tr>
					</tbody>
				</table>
		</div>	<!-- .data-table -->
		
		<br/>
		<h1>Key Related Commodities & Impact</h1>
		<table id="chart-avg-value-vol" class="table table-condensed table-hover table-responsive table-striped">
			<thead>
                <tr> 
                    <th>Movement</th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th>Impact</th>
                    <th></th>
                    <th></th>
                </tr>
                <tr> 
                    <th></th>
                    <th><font size="2">2015.06</font></th>
                    <th><font size="2">2016.06</font></th>
                    <th>YoY%</th>
                    <th></th>
                    <th><font size="2">2015.06</font></th>
                    <th><font size="2">2016.06</font></th>
                </tr>
			</thead>
			<tbody>
                <tr> 
                    <td>Currency 1</td>
                    <td>7.74</td>
                    <td>7.76</td>
                    <td><font color="green">+0.3%</font></td>
                    <td nowrap>Product 1</td>
                    <td>1.6%</td>
                    <td><font color="red">-3.8%</font></td>
                </tr>
                <tr> 
                    <td>Commodity 2</td>
                    <td>168.8</td>
                    <td>200.2</td>
                    <td><font color="green">+18.6%</font></td>
                    <td nowrap>Product 2</td>
                    <td>2.3%</td>
                    <td><font color="red">-10.2%</font></td>
                </tr>
                <tr> 
                    <td>Commodity 3</td>
                    <td>45.5</td>
                    <td>32.5</td>
                    <td><font color="red">-28.6%</font></td>
                    <td nowrap>Product 3</td>
                    <td><font color="red">-0.2%</font></td>
                    <td>8.6%</td>
                </tr>
			</tbody>
		</table>

        <br/>
		<br/>
		<br/>
		<br/>
		
	</div>	<!-- .right-content -->	
	
	
	<!-- Filter placeholder. Actual filter selected will be added via Javascript -->
	<div id="selectFilter" class="container col-md-2"></div>
    <br/>
	

</div>	<!-- .row -->

<div id="notes" class="col-md-12">
	<br/>
	<sup>1</sup>&nbsp;Values reflect the top categories with the highest shipment value.<br/>
	Total MOT (US $) = <span id="tot-MOT" /><br/>
	Total Shipment Value (US $) = <span id="tot-ship" /><br/>
</div>



{% block scripts %}
{% load staticfiles %}
<link rel="stylesheet" type="text/css" href="{% static 'app/content/dc.css' %}" media="screen" /> 
<script src="{% static 'app/scripts/crossfilter.min.js' %}"></script>
<script src="{% static 'app/scripts/d3-dc.min.js' %}"></script>
<script src="{% static 'app/scripts/dc.js' %}"></script>
<script src="{% static 'app/scripts/site/common-utility.js' %}"></script> <!-- site specific filters to appear on right panel -->

<script type="text/javascript">


	/*******************************************************
	Step 0: Set up Globals
	********************************************************/
	var debugFlag = 0;
	var formatString_axis = ".2s";
	var formatString_detail = ".3s";			
	var formatFunction_axis = function(d) {return d3.format(formatString_axis)(d).replace("G","B");};
	var formatFunction_detail = function(d) {
			var colorPrefix='';
			var colorSuffix='';
			if (d < 0) {
				colorPrefix='<font color="red">';
				colorSuffix='</font>';
			}
			return colorPrefix + d3.format(formatString_detail)(snap_to_zero(d)).replace("G","B") + colorSuffix;
		};
	var formatFunction_pct = function(d) {
			var colorPrefix='';
			var colorSuffix='';
			if (d < 0) {
				colorPrefix='<font color="red">';
				colorSuffix='</font>';
               }
                     return colorPrefix + d3.format(".1%")(snap_to_zero_percent(d)) + colorSuffix;
		};

	var formatFunction_rowDetail = function(d) {
			if (snap_to_zero(d) == 0)
                    return '';
			else
                    return formatFunction_detail(d);
		};
	var formatFunction_rowPct = function(d) {
			if (snap_to_zero_percent(d) == 0)
                    return '';
			else
                    return formatFunction_pct(d);
		};
     var formatFunction_tooltips = function(d) { return d3.format(formatString_detail)(snap_to_zero(d)).replace("G","B"); };
     var formatFunction_rowLabel = function(d) {
		if (snap_to_zero(d.value.ship) == 0)
			return '';
		else {
			var spaceLoc = d.key.indexOf(' ');
			if (spaceLoc < 0)
				return d.key;
			else
				return d.key.slice(0, spaceLoc); 
			}
		};
	var contentWidth = d3.select("#left-content").style("width").replace("px", "");
	var chartWidth = contentWidth * 0.9;
	var legend_x = 60;
	var legend_y = 10;
	var legend_itemHeight = 13;
	var legend_gap = 5;
	var num_rowsCap = 3;
	var chartTopMargin_row = -10;
	var chartWidth_row = contentWidth * 0.33;
	var chartHeight = 130;
	var fontSizeInUse = parseInt(d3.select("#left-content").style("font-size"));
     var perRowHeight = 18 / 12 * fontSizeInUse; // calculate from default setting for font-size=12px. To change font-size, modify body font-size in bootstrap.css.
	var chartHeight_row = num_rowsCap * perRowHeight;
	
	/*******************************************************
	Step 1: Prepare Data 
	********************************************************/

	var db_data = {{ data|safe }};
	if (debugFlag) {
		console.log("db_data"); console.log(db_data); // Debug
	}
	
	/*******************************************************
	Step 2: Create dc.js chart objects & link to div 
	********************************************************/

	var catChart = dc.rowChart("#chart-category");
	var catTbl = dc.dataTable("#table-category");
	var shipChart  = dc.compositeChart("#chart-shipment");
	var avgCostPriceChart   = dc.compositeChart("#chart-avg-cost");
	var avgValVolChart   = dc.dataTable("#chart-avg-value-vol");

	
	var totValueChart = dc.numberDisplay("#chart-tot-value");
	var totMOTChart = dc.numberDisplay("#chart-tot-mot");
	var totMOQChart = dc.numberDisplay("#chart-tot-moq");
	var pctValueChart = dc.numberDisplay("#chart-pct-value");
	var pctMOTChart = dc.numberDisplay("#chart-pct-mot");
	
	var motTbl_valuegrowth_value = dc.numberDisplay("#mot-table-valuegrowth-value");
	var motTbl_moq_value = dc.numberDisplay("#mot-table-moq-value");
	var motTbl_cpr_value = dc.numberDisplay("#mot-table-cpr-value");
	var motTbl_valuegrowth_pct = dc.numberDisplay("#mot-table-valuegrowth-pct");
	var motTbl_moq_pct = dc.numberDisplay("#mot-table-moq-pct");
	var motTbl_cpr_pct = dc.numberDisplay("#mot-table-cpr-pct");
	
	
	
	/*******************************************************
	Setp 3: Set up cross filter 
	********************************************************/

	var ndx = crossfilter(db_data);

	/*******************************************************
	Setp 4: Create dimensions
	A dimention is something to group or filter by.
	Crossfilter can filter by exact value or by range.
	********************************************************/

	var catDim = ndx.dimension(function(d) {return d.fields.category;});
	var shipVal_catgroup=catDim.group().reduceSum(function(d) {return d.fields.sum_shipment_value;});
	var shipVal_tot_group=ndx.groupAll().reduceSum(function(d) {return d.fields.sum_shipment_value;});
	if (debugFlag) {
		console.log("shipVal_tot_group"); console.log(shipVal_tot_group);
		console.log("shipVal_tot_group.value()"); console.log(shipVal_tot_group.value());
	}
	
	var catTblDim = catDim.group().reduce(
			// add
			function (p, v) {
				p.ship += v.fields.sum_shipment_value;
				p.vol += v.fields.sum_order_quantity;
				p.cat[v.fields.category] = (p.cat[v.fields.category] || 0) + v.fields.sum_shipment_value;
				return p;
			},
			// remove
			function (p, v) {
				p.ship -= v.fields.sum_shipment_value;
				p.vol -= v.fields.sum_order_quantity;
				p.cat[v.fields.category] -= v.fields.sum_shipment_value;
				return p;
			},
			// init
			function () {
				return {ship: 0, vol: 0, cat: {}};
			}
		);
	
	var yearDim = ndx.dimension(function(d) {return d.fields.year;});
	var shipVal_group=yearDim.group().reduceSum(function(d) {return d.fields.sum_shipment_value;});
	var shipVol_group=yearDim.group().reduceSum(function(d) {return d.fields.sum_order_quantity;});
	var skuCount_group=yearDim.group().reduceSum(function(d) {return d.fields.num_sku;});
	
	var avgValPerSku_grouped_dim = yearDim.group().reduce(
			// add
			function (p, v) {
				p.number_sku += +v.fields.num_sku;
				p.number_po += +v.fields.num_po;
				p.ship += +v.fields.sum_shipment_value;
				p.vol += +v.fields.sum_order_quantity;
				p.avg_val_per_sku = (p.number_sku == 0) ? 0 : Math.round(p.ship / p.number_sku);
				p.avg_val_per_po = (p.number_po == 0) ? 0 : Math.round(p.ship / p.number_po);
				p.avg_vol_per_sku = (p.number_sku == 0) ? 0 : Math.round(p.vol / p.number_sku);
				p.avg_vol_per_po = (p.number_po == 0) ? 0 : Math.round(p.vol / p.number_po);
				p.avg_cost_price = (p.vol == 0) ? 0 : Math.round(p.ship / p.vol);
				return p;
			},
			// remove
			function (p, v) {
				p.number_sku -= +v.fields.num_sku;
				p.number_po -= +v.fields.num_po;
				p.ship -= +v.fields.sum_shipment_value;
				p.vol -= +v.fields.sum_order_quantity;
				p.avg_val_per_sku = (p.number_sku == 0) ? 0 : Math.round(p.ship / p.number_sku);
				p.avg_val_per_po = (p.number_po == 0) ? 0 : Math.round(p.ship / p.number_po);
				p.avg_vol_per_sku = (p.number_sku == 0) ? 0 : Math.round(p.vol / p.number_sku);
				p.avg_vol_per_po = (p.number_po == 0) ? 0 : Math.round(p.vol / p.number_po);
				p.avg_cost_price = (p.vol == 0) ? 0 : Math.round(p.ship / p.vol);
				return p;
			},
			// init
			function () {
				return {number_sku: 0, number_po: 0, ship: 0, vol: 0, avg_val_per_sku: 0, avg_val_per_po: 0, avg_vol_per_sku: 0, avg_vol_per_po: 0, avg_cost_price: 0};
			}
		);


	
	// add
	var reduceAdd_Fn = function(p, v) {
			p.ship +=  v.fields.sum_shipment_value;
			p.tsp_valueGrowth += v.fields.TSP_ValueGrowth;
			p.tsp_moq += v.fields.TSP_MOQ;
			p.tsp_costpricerecovery += v.fields.TSP_CostPriceRecovery;
			p.mot += v.fields.TSP_MOT;
			return p;
		};
	// remove
	var reduceRemove_Fn = function(p, v) {
			p.ship -=  v.fields.sum_shipment_value;
			p.tsp_valueGrowth -= v.fields.TSP_ValueGrowth;
			p.tsp_moq -= v.fields.TSP_MOQ;
			p.tsp_costpricerecovery -= v.fields.TSP_CostPriceRecovery;
			p.mot -= v.fields.TSP_MOT;
			return p;
		};
	// init
	var reduceInit_Fn = function() {
			return {ship: 0, tsp_valueGrowth: 0, tsp_moq: 0, tsp_costpricerecovery: 0, mot: 0};
			};

			
	var orderFunction_rowChart = function(d) { 
				var rtn = snap_to_zero(d.value.ship); 
				if (rtn == 0)
					rtn = -999999999999;
				return -rtn; };
	var orderFunction_dataTable = function(d) { 
				var rtn = snap_to_zero(d.value.ship); 
				if (rtn == 0)
					rtn = -999999999999;
				return rtn; };
	var orderFunction_dimension = function(d) { 
				var rtn = snap_to_zero(d.ship); 
				if (rtn == 0)
					rtn = -999999999999;
				return rtn; };
                
	var mot_grouped_dim = ndx.groupAll().reduce(reduceAdd_Fn, reduceRemove_Fn, reduceInit_Fn);
	var tot_ship = snap_to_zero(mot_grouped_dim.value().ship);
	var tot_mot = snap_to_zero(mot_grouped_dim.value().mot);
	var cat_grouped_dim = catDim.group().reduce(reduceAdd_Fn, reduceRemove_Fn, reduceInit_Fn).order(orderFunction_dimension);

	if (debugFlag) {
		console.log("mot_grouped_dim"); console.log(mot_grouped_dim);
		console.log("mot_grouped_dim.value()"); console.log(mot_grouped_dim.value());
		console.log("mot_grouped_dim.value().mot"); console.log(mot_grouped_dim.value().mot);
	}
	
	/*******************************************************
	Step 5: Create Main Charts for Visualization
	********************************************************/

	d3.select("#tot-MOT").html(function(d, i) {return formatFunction_detail(tot_mot)} );
	d3.select("#tot-ship").html(function(d, i) {return formatFunction_detail(tot_ship)} );
	
	// Category row chart
	catChart
		.width(chartWidth_row) 
		.height(chartHeight_row) 
		.x(d3.scale.linear()) 
		.elasticX(true) 
		.dimension(catDim) 
		.group(cat_grouped_dim)
		.valueAccessor(function(d) {return snap_to_zero(d.value.ship)}) 
		.ordering(orderFunction_rowChart)
		.rowsCap(num_rowsCap)
		.othersGrouper(false) 
		.xAxis().ticks(0)
//		.xAxis().tickFormat(function(v) {return "";})
		; 
	catChart.label(function (d) {return '';});
	catChart.title(function(d) { return d.key + ": " + formatFunction_tooltips(d.value.ship); });
	catChart.margins().top = catChart.margins().top + chartTopMargin_row;
	catChart.margins().bottom = -5;
	catChart.margins().left = 0;
	catChart.margins().right = 90;

		
	catTbl
		.dimension(catTblDim)
		.group(function (p) { return "" })
		.columns([
			formatFunction_rowLabel,
//			function(d) { return d.key; },
			function(d) { return formatFunction_rowDetail(d.value.ship); },
			function(d) { return formatFunction_rowPct(d.value.ship / tot_ship); },
			function(d) { return formatFunction_rowDetail(d.value.vol); }
		])
		.sortBy(orderFunction_dataTable)
		.order(d3.descending)
		.showGroups(false)
		.endSlice(num_rowsCap)
		;

		
	// Shipment Value & Volume
	var shipChart_val = dc.barChart(shipChart) 
				.group(shipVal_group,"Value")
				.barPadding(0.5)
				.centerBar(true)
				;
	var shipChart_vol = dc.lineChart(shipChart) 
				.colors('orange') 
				.group(shipVol_group,"Volume")
				.useRightYAxis(true)
				;
	var barWidthAdjustFunction = function(chart) {
			chart.svg().selectAll('rect.bar').attr('width', 20).attr('transform', 'translate(-10,0)');
			var transformStr = chart.select("text.y-axis-label.yr-label").attr('transform');
			chart.select("text.y-axis-label.yr-label").attr('transform', transformStr.replace('rotate(90)', 'rotate(-90)'));
			};	 // workaround to adjust the bar width
			
	shipChart
		.width(chartWidth)
		.height(chartHeight)
		.dimension(yearDim) 
		.group(shipVal_group)		// set the group or else the ordinal scale won't work
		.x(d3.scale.ordinal())
		.xUnits(dc.units.ordinal)
		._rangeBandPadding(1)		// ordinal axis on composite are misaligned. this is a temporary fix according to https://github.com/dc-js/dc.js/issues/662 
		.elasticY(true)
		.legend(dc.legend().x(legend_x).y(legend_y).itemHeight(legend_itemHeight).gap(legend_gap))
		.renderHorizontalGridLines(true)
        .compose([ 
			shipChart_val
				,
			shipChart_vol
			
			]) 
		.brushOn(false)
		.on('renderlet', barWidthAdjustFunction)
		;
		
	if (debugFlag) {
		console.log("shipChart_val"); console.log(shipChart_val);
	}
	shipChart
		.yAxisLabel("Value (US $)")
		.yAxis().tickFormat(formatFunction_axis)
		.ticks(5)
		;
	shipChart
		.rightYAxisLabel("Volume (Units)")
		.rightYAxis().tickFormat(formatFunction_axis)
		.ticks(5)
		;
	// programmer note: Do not chain .yAxis because everything else afterwards will not work.
	fixYAxisLabelOverlap(shipChart, 'left');
	fixYAxisLabelOverlap(shipChart, 'right');
	// y-axis label seems to be off. This is temporary solution till CSS is fixed.
	
	
	// Cost Price

	var avgCostPriceChart_cost = dc.barChart(avgCostPriceChart) 
				.group(avgValPerSku_grouped_dim,"Cost Price")
                    .valueAccessor(function(d) { return snap_to_zero(d.value.avg_cost_price); })
				.barPadding(0.5)
				.centerBar(true)
				;

	var avgCostPriceChart_sku = dc.lineChart(avgCostPriceChart) 
				.colors('orange') 
				.group(skuCount_group,"# of SKU")
				.useRightYAxis(true)
				;
	avgCostPriceChart
		.width(chartWidth)
		.height(chartHeight)
		.dimension(yearDim) 
		.group(skuCount_group)		// set the group or else the ordinal scale won't work
		.x(d3.scale.ordinal())
		.xUnits(dc.units.ordinal)
		._rangeBandPadding(1)		// ordinal axis on composite are misaligned. this is a temporary fix according to https://github.com/dc-js/dc.js/issues/662 
		.elasticY(true)
		.legend(dc.legend().x(legend_x).y(legend_y).itemHeight(legend_itemHeight).gap(legend_gap))
		.renderHorizontalGridLines(true)
        .compose([ 
			avgCostPriceChart_cost
				,
			avgCostPriceChart_sku
			
			]) 
		.brushOn(false)
		.on('renderlet', barWidthAdjustFunction) // workaround to adjust the bar width
		;
		
//	if (debugFlag) {
//		console.log("avgCostPriceChart_cost"); console.log(avgCostPriceChart_cost);
//	}
	avgCostPriceChart
		.yAxisLabel("Cost Price($/Unit)")
		.yAxis().tickFormat(function(d) {return d3.format(".2d")(d).replace("G","B");})
		.ticks(5)
		;
	avgCostPriceChart
		.rightYAxisLabel("# SKU (Units)")
		.rightYAxis().tickFormat(formatFunction_axis)
		.ticks(5)
		;
	// programmer note: Do not chain .yAxis because everything else afterwards will not work.
	fixYAxisLabelOverlap(avgCostPriceChart, 'left');
	fixYAxisLabelOverlap(avgCostPriceChart, 'right');
	// y-axis label seems to be off. This is temporary solution till CSS is fixed.
	

	
	// per SKU and per PO
	avgValVolChart
		.dimension(avgValPerSku_grouped_dim)
		.group(function (p) { return "" })
		.columns([
			function(d) { return d.key; },
			function(d) { return formatFunction_detail(d.value.avg_val_per_sku); },
			function(d) { return formatFunction_detail(d.value.avg_val_per_po); },
			function(d) { return formatFunction_detail(d.value.avg_vol_per_sku); },
			function(d) { return formatFunction_detail(d.value.avg_vol_per_po); }
		])
		.sortBy(function (d) { return -d.key })
		.order(d3.descending)
		.showGroups(false)
		;

	
	
	totValueChart
		.group(mot_grouped_dim)
		.valueAccessor(function(d) {
				var tot = 0; 
				for (var i=0; i<num_rowsCap; i++) {
					tot += cat_grouped_dim.top(num_rowsCap)[i].value.ship;
				}; 
				return snap_to_zero(tot); 
			})
		.formatNumber(formatFunction_detail);
		;
	
	totMOTChart
		.group(mot_grouped_dim)
		.valueAccessor(function(d) {
				var tot = 0; 
				for (var i=0; i<num_rowsCap; i++) {
					tot += cat_grouped_dim.top(num_rowsCap)[i].value.mot;
				}; 
				return snap_to_zero(tot); 
			})
		.formatNumber(formatFunction_detail);
		;
	
	totMOQChart
		.group(mot_grouped_dim)
		.valueAccessor(function(d) {
				var sum_denom = 0; 
				var sum_num = 0; 
				for (var i=0; i<num_rowsCap; i++) {
					sum_denom += cat_grouped_dim.top(num_rowsCap)[i].value.ship; 
					sum_num += cat_grouped_dim.top(num_rowsCap)[i].value.tsp_moq;
				}; 
				return (sum_denom == 0) ? 0 : (snap_to_zero(sum_num) / sum_denom); 
			})
		.formatNumber(formatFunction_pct);
		;
	
	pctValueChart
		.group(mot_grouped_dim)
		.valueAccessor(function(d) {
				var tot = 0; 
				for (var i=0; i<num_rowsCap; i++) {
					tot += cat_grouped_dim.top(num_rowsCap)[i].value.ship;
					}; 
				return (tot_ship == 0) ? 0 : (snap_to_zero(tot) / tot_ship); 
			})
		.formatNumber(formatFunction_pct);
		;
	
	pctMOTChart
		.group(mot_grouped_dim)
		.valueAccessor(function(d) {
				var tot = 0; 
				for (var i=0; i<num_rowsCap; i++) {
					tot += cat_grouped_dim.top(num_rowsCap)[i].value.mot;
				}; 
				return (tot_mot == 0) ? 0 : (snap_to_zero(tot) / tot_mot); 
			})
		.formatNumber(formatFunction_pct);
		;
	
	
	motTbl_valuegrowth_value
		.group(mot_grouped_dim)
		.valueAccessor(function(d) {
				var tot = 0; 
				for (var i=0; i<num_rowsCap; i++) {
					tot += cat_grouped_dim.top(num_rowsCap)[i].value.tsp_valueGrowth;
				}; 
				return snap_to_zero(tot); 
			})
		.formatNumber(formatFunction_detail);
		;

	motTbl_moq_value
		.group(mot_grouped_dim)
		.valueAccessor(function(d) {
				var tot = 0; 
				for (var i=0; i<num_rowsCap; i++) {
					tot += cat_grouped_dim.top(num_rowsCap)[i].value.tsp_moq;
				}; 
				return snap_to_zero(tot); 
			})
		.formatNumber(formatFunction_detail);
		;

	motTbl_cpr_value
		.group(mot_grouped_dim)
		.valueAccessor(function(d) {
				var tot = 0; 
				for (var i=0; i<num_rowsCap; i++) {
					tot += cat_grouped_dim.top(num_rowsCap)[i].value.tsp_costpricerecovery;
				}; 
				return snap_to_zero(tot); 
			})
		.formatNumber(formatFunction_detail);
		;
		
	motTbl_valuegrowth_pct
		.group(mot_grouped_dim)
		.valueAccessor(function(d) {
				var sum_denom = 0; 
				var sum_num = 0; 
				for (var i=0; i<num_rowsCap; i++) {
					sum_denom += cat_grouped_dim.top(num_rowsCap)[i].value.mot; 
					sum_num += cat_grouped_dim.top(num_rowsCap)[i].value.tsp_valueGrowth;
					}; 
				return (sum_denom == 0) ? 0 : (snap_to_zero(sum_num) / sum_denom); 
			})
		.formatNumber(formatFunction_pct);
		;

	motTbl_moq_pct
		.group(mot_grouped_dim)
		.valueAccessor(function(d) {
				var sum_denom = 0; 
				var sum_num = 0; 
				for (var i=0; i<num_rowsCap; i++) {
					sum_denom += cat_grouped_dim.top(num_rowsCap)[i].value.mot; 
					sum_num += cat_grouped_dim.top(num_rowsCap)[i].value.tsp_moq;
					}; 
				return (sum_denom == 0) ? 0 : (snap_to_zero(sum_num) / sum_denom); 
			})
		.formatNumber(formatFunction_pct);
		;

	motTbl_cpr_pct
		.group(mot_grouped_dim)
		.valueAccessor(function(d) {
				var sum_denom = 0; 
				var sum_num = 0; 
				for (var i=0; i<num_rowsCap; i++) {
					sum_denom += cat_grouped_dim.top(num_rowsCap)[i].value.mot; 
					sum_num += cat_grouped_dim.top(num_rowsCap)[i].value.tsp_costpricerecovery;
				}; 
				return (sum_denom == 0) ? 0 : (snap_to_zero(sum_num) / sum_denom); 
			})
		.formatNumber(formatFunction_pct);
		;
		

	/*******************************************************
	Step 6: Set up Side Panel Filters
	********************************************************/

	var showFilters = {{ filters|safe }};
	setupFilter(ndx, showFilters);

		
	/*******************************************************
	Step 7: Render the Charts
	********************************************************/

	dc.renderAll();

	
</script>
{% endblock %}
